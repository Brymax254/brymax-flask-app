{% extends "base.html" %}
{% block content %}
<div class="container mt-4">

  <!-- Payment Receipt Section (If Available) -->
  {% if receipt %}
  <div class="card shadow-sm mb-4 border-primary">
    <div class="card-header bg-primary text-white">
      <h4 class="card-title mb-0">
        <i class="bi bi-receipt-cutoff me-2"></i> Payment Receipt
      </h4>
    </div>
    <div class="card-body">
      <ul class="list-group list-group-flush">
        <li class="list-group-item"><strong>Receipt Number:</strong> {{ receipt.receipt_number }}</li>
        <li class="list-group-item"><strong>Date:</strong> {{ receipt.date }}</li>
        <li class="list-group-item"><strong>Farmer Name:</strong> {{ receipt.farmer.full_name }}</li>
        <li class="list-group-item"><strong>Farmer ID:</strong> {{ receipt.farmer.unique_number }}</li>
        <li class="list-group-item"><strong>Phone Number:</strong> {{ receipt.farmer.phone_number }}</li>
        <li class="list-group-item"><strong>Clean Harvest (Kg):</strong> {{ receipt.total_clean or 'N/A' }}</li>
        <li class="list-group-item"><strong>Husk Harvest (Kg):</strong> {{ receipt.total_husk or 'N/A' }}</li>
        <li class="list-group-item"><strong>Total Payment:</strong> Ksh {{ receipt.total_payment | round(2) if receipt.total_payment else 'N/A' }}</li>
        <li class="list-group-item"><strong>Payment Method:</strong> {{ receipt.payment_method }}</li>
      </ul>
    </div>
  </div>
  {% endif %}

  <!-- Farmers Quick Summary Table -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Farmers Quick Summary</h2>
    <div>
      <button class="btn btn-outline-primary btn-sm me-2" id="exportQuick">
        <i class="bi bi-download"></i> Export Quick Summary
      </button>
      <button class="btn btn-outline-danger btn-sm" id="deleteSelectedQuick">
        <i class="bi bi-trash"></i> Delete Selected
      </button>
    </div>
  </div>
  <div class="table-responsive mb-5">
    <table class="table table-sm table-bordered table-striped">
      <thead class="table-light">
        <tr>
          <th><input type="checkbox" id="selectAllQuick"></th>
          <th>Farmer Name</th>
          <th>County</th>
          <th>Subcounty</th>
          <th>Ward</th>
          <th>Acres</th>
          <th>Village</th>
          <th>Phone Number</th>
          <th>Field Officer</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for farmer in farmers %}
        <tr>
          <td><input type="checkbox" class="selectFarmerQuick" data-id="{{ farmer.unique_number }}"></td>
          <td>{{ farmer.full_name }}</td>
          <td>{{ farmer.county }}</td>
          <td>{{ farmer.subcounty }}</td>
          <td>{{ farmer.ward }}</td>
          <td>{{ farmer.land_size }}</td>
          <td>{{ farmer.village }}</td>
          <td>{{ farmer.phone_number }}</td>
          <td>{{ farmer.field_officer }}</td>
          <td>
            <button class="btn btn-danger btn-sm" onclick="deleteSingleFarmer('{{ farmer.unique_number }}')">
              <i class="bi bi-trash"></i> Delete
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Detailed Farmers Section -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Registered Farmers - Detailed View</h2>
    <div>
      <button class="btn btn-outline-primary btn-sm me-2" id="exportDetailed">
        <i class="bi bi-download"></i> Export Detailed
      </button>
      <button class="btn btn-danger btn-sm" id="deleteSelected">
        <i class="bi bi-trash"></i> Delete Selected
      </button>
      <select class="form-select w-25 d-inline-block" id="seasonFilter">
        <option value="">Sort by Season</option>
        <option value="OND">OND</option>
        <option value="MAM">MAM</option>
      </select>
    </div>
  </div>
  <div class="table-responsive">
    <table id="farmersTable" class="table table-striped table-bordered">
      <thead class="table-dark">
        <tr>
          <th><input type="checkbox" id="selectAll"></th>
          <th>Farmer ID</th>
          <th>Name</th>
          <th>County</th>
          <th>Subcounty</th>
          <th>Ward</th>
          <th>Location</th>
          <th>Phone Number</th>
          <th>Village</th>
          <th>Land Size (acres)</th>
          <th>Season</th>
          <th>Fertilizer Type</th>
          <th>Kgs Issued</th>
          <th>Kgs Harvested (Clean)</th>
          <th>Kgs Harvested (Husk)</th>
          <th>Total Payment</th>
          <th>Amount Received</th>
          <th>Last Harvest Date</th>
          <th>Last Payment Date</th>
          <th>Field Officer</th>
          <th>Make Payment</th>
        </tr>
      </thead>
      <tbody>
        {% for farmer in farmers %}
        <tr class="farmer-row" data-season="{{ farmer.season }}">
          <td><input type="checkbox" class="selectFarmer" data-id="{{ farmer.unique_number }}"></td>
          <td>{{ farmer.unique_number }}</td>
          <td>{{ farmer.full_name }}</td>
          <td>{{ farmer.county }}</td>
          <td>{{ farmer.subcounty }}</td>
          <td>{{ farmer.ward }}</td>
          <td>{{ farmer.location }}</td>
          <td class="{% if farmer.phone_number|length < 10 or farmer.phone_number|length > 13 %}bg-warning{% endif %}">
            {{ farmer.phone_number }}
          </td>
          <td>{{ farmer.village }}</td>
          <td>{{ farmer.land_size }}</td>
          <td>{{ farmer.season }}</td>
          <td>{{ farmer.fertilizer_type or 'N/A' }}</td>
          <td>{{ farmer.kgs_issued or 'N/A' }}</td>
          <td>{{ farmer.kgs_harvested_clean or 'N/A' }}</td>
          <td>{{ farmer.kgs_harvested_husk or 'N/A' }}</td>
          <td>Ksh {{ ((farmer.kgs_harvested_clean or 0) * 52 + (farmer.kgs_harvested_husk or 0) * 26) | round(2) }}</td>
          <td>{{ farmer.amount_received or 'N/A' }}</td>
          <td>{{ farmer.last_harvest_date.strftime("%Y-%m-%d") if farmer.last_harvest_date else 'N/A' }}</td>
          <td>{{ farmer.last_payment_date.strftime("%Y-%m-%d") if farmer.last_payment_date else 'N/A' }}</td>
          <td>{{ farmer.field_officer }}</td>
          <td>
            <a href="{{ url_for('main.payment', farmer_id=farmer.unique_number) }}" class="btn btn-primary btn-sm">
              <i class="bi bi-cash"></i> Pay
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- JavaScript Section -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    // Quick Summary: Select All Checkboxes
    document.getElementById("selectAllQuick").addEventListener("change", function () {
        let checkboxes = document.querySelectorAll(".selectFarmerQuick");
        checkboxes.forEach(cb => cb.checked = this.checked);
    });

    // Detailed Table: Select All Checkboxes
    document.getElementById("selectAll").addEventListener("change", function () {
        let checkboxes = document.querySelectorAll(".selectFarmer");
        checkboxes.forEach(cb => cb.checked = this.checked);
    });

    // Bulk Delete for Detailed Table
    document.getElementById("deleteSelected").addEventListener("click", function () {
        let selectedFarmers = Array.from(document.querySelectorAll(".selectFarmer:checked")).map(cb => cb.getAttribute("data-id"));
        if (selectedFarmers.length === 0) {
            alert("Please select farmers to delete.");
            return;
        }
        if (confirm("Are you sure you want to delete the selected farmers?")) {
            fetch("{{ url_for('main.delete_farmers') }}", {
                method: "POST",
                body: JSON.stringify({ farmer_ids: selectedFarmers }),
                headers: {
                  "Content-Type": "application/json"
                }
            }).then(response => {
                if (response.ok) {
                    alert("Farmers deleted successfully!");
                    location.reload();
                } else {
                    alert("Error deleting farmers.");
                }
            });
        }
    });

    // Bulk Delete for Quick Summary Table
    document.getElementById("deleteSelectedQuick").addEventListener("click", function () {
        let selectedFarmers = Array.from(document.querySelectorAll(".selectFarmerQuick:checked")).map(cb => cb.getAttribute("data-id"));
        if (selectedFarmers.length === 0) {
            alert("Please select farmers to delete from the Quick Summary.");
            return;
        }
        if (confirm("Are you sure you want to delete the selected farmers from the Quick Summary?")) {
            fetch("{{ url_for('main.delete_farmers') }}", {
                method: "POST",
                body: JSON.stringify({ farmer_ids: selectedFarmers }),
                headers: {
                  "Content-Type": "application/json"
                }
            }).then(response => {
                if (response.ok) {
                    alert("Farmers deleted successfully!");
                    location.reload();
                } else {
                    alert("Error deleting farmers.");
                }
            });
        }
    });

    // Sorting Detailed Table by Season
    document.getElementById("seasonFilter").addEventListener("change", function () {
        let selectedSeason = this.value;
        document.querySelectorAll(".farmer-row").forEach(row => {
            row.style.display = (selectedSeason === "" || row.getAttribute("data-season") === selectedSeason) ? "" : "none";
        });
    });

    // Export Quick Summary Table
    document.getElementById("exportQuick").addEventListener("click", function () {
        window.open("{{ url_for('main.export_quick_summary_excel') }}");
    });

    // Export Detailed Table
    document.getElementById("exportDetailed").addEventListener("click", function () {
        window.open("{{ url_for('main.export_farmers_excel') }}");
    });
});

// Individual delete for Quick Summary Table
function deleteSingleFarmer(farmerId) {
    if(confirm("Are you sure you want to delete this farmer?")) {
        fetch("{{ url_for('main.delete_farmers') }}", {
            method: "POST",
            body: JSON.stringify({ farmer_ids: [farmerId] }),
            headers: { "Content-Type": "application/json" }
        }).then(response => {
            if(response.ok) {
                alert("Farmer deleted successfully!");
                location.reload();
            } else {
                alert("Error deleting farmer.");
            }
        });
    }
}
</script>
{% endblock %}
